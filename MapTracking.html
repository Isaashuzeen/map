<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Map with Route Polyline</title>
    <style>
      body {
        margin: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      #map {
        width: 100%;
        height: 100vh;
      }
      .input-container {
        display: flex;
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1;
        background: white;
        border-radius: 4px;
        padding: 10px;
      }
      .input-container select {
        margin-right: 5px;
        padding: 5px;
      }
    </style>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrfQWGAKnrdUFK0FBg8LQRSkQt_xzwwuw&libraries=places&callback=initMap"
      async
      defer
    ></script>
    <script>
      let map;
      let directionsService;
      let directionsRenderer;
      let isLocationsFetched = false;

      function initMap() {
        const initialLocation = {
          lat: 13.150168574952062,
          lng: 123.71410910859481,
        };

        map = new google.maps.Map(document.getElementById("map"), {
          center: initialLocation,
          zoom: 18,
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
          polylineOptions: {
            strokeColor: "red",
            strokeOpacity: 1.0,
            strokeWeight: 5,
          },
          suppressMarkers: true,
        });
        directionsRenderer.setMap(map);

        const initialMarker = new google.maps.Marker({
          position: initialLocation,
          map: map,
          icon: {
            url: "alarm.png",
            scaledSize: new google.maps.Size(40, 40),
          },
        });

        fetchLocations();
      }

      function fetchLocations() {
        if (isLocationsFetched) return;

        const username = "root"; // Secure this!
        const password = "root"; // Secure this!
        const headers = new Headers({
          Authorization: "Basic " + btoa(username + ":" + password),
        });

        fetch("http://127.0.0.1:5984/locations/_all_docs?include_docs=true", {
          headers,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                "Network response was not ok: " + response.statusText
              );
            }
            return response.json();
          })
          .then((data) => {
            console.log("Fetched data:", data);
            populateDropdown(data);
            isLocationsFetched = true;
          })
          .catch((error) => {
            console.error("Error fetching locations:", error);
            alert("Error fetching locations. Please try again later.");
          });
      }

      function populateDropdown(data) {
        const select = document.getElementById("destination-select");
        const existingNames = new Set();

        data.rows.forEach((row) => {
          if (row.doc.latitude && row.doc.longitude && row.doc.name) {
            if (!existingNames.has(row.doc.name)) {
              existingNames.add(row.doc.name);
              const option = document.createElement("option");
              const latLng = `${row.doc.latitude},${row.doc.longitude}`;
              option.value = latLng;
              option.textContent = row.doc.name;
              select.appendChild(option);
            }
          }
        });
      }

      function drawRoute(origin, destination) {
        const request = {
          origin: origin,
          destination: destination,
          travelMode: google.maps.TravelMode.WALKING,
        };

        directionsService.route(request, (result, status) => {
          if (status === google.maps.DirectionsStatus.OK) {
            directionsRenderer.setDirections(result);
            const destinationLocation = result.routes[0].legs[0].end_location;

            const destinationMarker = new google.maps.Marker({
              position: destinationLocation,
              map: map,
              icon: {
                url: "transport.png",
                scaledSize: new google.maps.Size(40, 40),
              },
            });
          } else {
            console.error("Error fetching directions:", status);
            alert("Unable to fetch directions: " + status);
          }
        });
      }

      function setLocations() {
        const destinationInput = document
          .getElementById("destination-select")
          .value.split(",");
        const destinationLat = parseFloat(destinationInput[0]);
        const destinationLng = parseFloat(destinationInput[1]);

        console.log("Parsed destination:", destinationLat, destinationLng);

        if (isNaN(destinationLat) || isNaN(destinationLng)) {
          alert("Invalid latitude or longitude.");
          return;
        }

        const destinationLocation = new google.maps.LatLng(
          destinationLat,
          destinationLng
        );
        const startLocation = new google.maps.LatLng(
          13.150168574952062,
          123.71410910859481
        );
        drawRoute(startLocation, destinationLocation);
      }
    </script>
  </head>
  <body>
    <div class="input-container">
      <select id="destination-select">
        <option value="">Select Destination</option>
      </select>
      <button onclick="setLocations()">Show Route</button>
    </div>
    <div id="map"></div>
  </body>
</html>
