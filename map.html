<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Map Display</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #map {
        height: 100%;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
      import {
        getFirestore,
        getDocs,
        collection,
        onSnapshot,
      } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAkG27RMcJ-DF_BgpEToO64OKeUp4p1Ilo",
        authDomain: "routefetching.firebaseapp.com",
        projectId: "routefetching",
        storageBucket: "routefetching.appspot.com",
        messagingSenderId: "586802315319",
        appId: "1:586802315319:web:eadaa5d8bbaed224ab7fb2",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const googleMapsApiKey = "AIzaSyBrfQWGAKnrdUFK0FBg8LQRSkQt_xzwwuw"; // Replace with your Google Maps API key

      const initialPosition = {
        lat: 13.150168574952062,
        lng: 123.71410910859481,
      };

      let map;
      let directionsService;
      let directionsRenderer;
      let initialMarker;
      let destinationMarker;

      window.initMap = function () {
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 18,
          center: initialPosition,
          mapTypeControl: false,
          streetViewControl: false,
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
          polylineOptions: {
            strokeColor: "#FF0000",
            strokeOpacity: 1.0,
            strokeWeight: 5,
          },
          map: map,
          suppressMarkers: true, // Disable default markers
        });

        // Create initial position marker
        initialMarker = new google.maps.Marker({
          position: initialPosition,
          map: map,
          icon: 'alarm.png', // Custom icon for initial position
        });

        onSnapshot(collection(db, "routes"), (querySnapshot) => {
          updateMapWithDestination();
        });

        updateMapWithDestination();
      };

      async function updateMapWithDestination() {
        const querySnapshot = await getDocs(collection(db, "routes"));
        let destination = null;

        querySnapshot.forEach((docSnapshot) => {
          const data = docSnapshot.data();
          if (data.flag) {
            destination = { lat: data.lat, lng: data.lng };
          }
        });

        if (destination) {
          map.setCenter(destination);

          const request = {
            origin: initialPosition,
            destination: destination,
            travelMode: google.maps.TravelMode.DRIVING,
          };

          directionsService.route(request, (result, status) => {
            if (status === google.maps.DirectionsStatus.OK) {
              directionsRenderer.setDirections(result);

              // Get the end location from the directions result
              const endLocation = result.routes[0].legs[0].end_location;

              // Update the destination marker
              if (destinationMarker) {
                destinationMarker.setMap(null); // Remove old marker if it exists
              }

              destinationMarker = new google.maps.Marker({
                position: endLocation, // Set marker position to end of polyline
                map: map,
                icon: 'rescue.png', // Custom icon for destination
              });
            } else {
              alert("Directions request failed due to " + status);
            }
          });
        }
      }

      const script = document.createElement("script");
      script.src = `https://maps.googleapis.com/maps/api/js?key=${googleMapsApiKey}&libraries=places&callback=initMap`;
      script.async = true;
      document.head.appendChild(script);
    </script>
  </body>
</html>
